var rasterMap = (function (exports) {
  'use strict';

  function drawTiles(display, x0, y0, zoom) {
    // Define some constants
    const tmsRoot = "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/";
    const token = "pk.eyJ1IjoiamhlbWJkIiwiYSI6ImNqcHpueHpyZjBlMjAzeG9kNG9oNzI2NTYifQ.K7fqhk2Z2YZ8NIV94M-5nA";
    const tileSize = 256;
    const numX = 4;
    const numY = 2;

    var imax = 2 ** zoom;

    // Load tiles and draw on canvas.
    // Note: could return images array instead of drawing on canvas?
    const images = [];
    for (let iy = 0; iy < numY; iy++) {
      var ypx = iy * tileSize;
      var y = wrap(y0 + iy, imax);
      images[iy] = [];

      for (let ix = 0; ix < numX; ix++) {
        var xpx = ix * tileSize;
        var x = wrap(x0 + ix, imax);
        images[iy][ix] = new Image();

        console.log(x + "," + y + ": " + xpx + "," + ypx);
        images[iy][ix].xpx = xpx;
        images[iy][ix].ypx = ypx;
        images[iy][ix].onload = drawTile;
        images[iy][ix].src = tmsRoot + tileSize + "/" + zoom + "/" + x + "/" + y + 
          "/" + "?access_token=" + token;
        console.log(images[iy][ix].src);
      }
    }

    function drawTile() {
      display.drawImage(this, this.xpx, this.ypx);
    }
  }

  function wrap(x, xmax) {
    while (x < 0) {
      x += xmax;
    }
    while (x >= xmax) {
      x -= xmax;
    }
    return x;
  }

  function main() {

    // Set initial values
    var x0 = 1;
    var y0 = 0;
    var zoom = 1;

    // Setup canvases
    const visibleCanvas = document.getElementById("visibleCanvas");
    var display = visibleCanvas.getContext("2d", { premultipliedAlpha: false });
    display.canvas.width = display.canvas.clientWidth;
    display.canvas.height = display.canvas.clientHeight;
    console.log("display size: " + display.canvas.width + " x " + display.canvas.height);

    var up = document.getElementById("up");
    up.addEventListener("click", function(click) {
      y0--;
      drawTiles(display, x0, y0, zoom);
    }, false);
    var down = document.getElementById("down");
    down.addEventListener("click", function(click) {
      y0++;
      drawTiles(display, x0, y0, zoom);
    }, false);
    var left = document.getElementById("left");
    left.addEventListener("click", function(click) {
      x0--;
      drawTiles(display, x0, y0, zoom);
    }, false);
    var right = document.getElementById("right");
    right.addEventListener("click", function(click) {
      x0++;
      drawTiles(display, x0, y0, zoom);
    }, false);

    var zoomIn = document.getElementById("zoomIn");
    zoomIn.addEventListener("click", function(click) {
      //zoom = Math.min(zoom + 1, maxZoom);
      zoom++;
      x0 = 2 * x0 + 2; // TODO: these formula depend on numX, numY
      y0 = 2 * y0 + 1;
      drawTiles(display, x0, y0, zoom);
    }, false);
    var zoomOut = document.getElementById("zoomOut");
    zoomOut.addEventListener("click", function(click) {
      //zoom = Math.max(zoom - 1, minZoom);
      zoom--;
      x0 = Math.ceil( (x0 - 2) / 2 );
      y0 = Math.ceil( (y0 - 1) / 2 );
      drawTiles(display, x0, y0, zoom);
    }, false);

    drawTiles(display, x0, y0, zoom);
  }

  exports.main = main;

  return exports;

}({}));
